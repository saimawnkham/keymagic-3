import { Colors } from "../theme/colors.slint";
import { Fonts } from "../theme/fonts.slint";
import { Styles } from "../theme/styles.slint";
import { Button, CheckBox, ComboBox, ScrollView } from "std-widgets.slint";
import { HotkeyInput } from "hotkey_input.slint";
import { HotkeyDialog } from "hotkey_dialog.slint";
import { KeyboardInfo } from "../types.slint";

export component SettingsPage inherits Rectangle {
    in-out property <[KeyboardInfo]> keyboards: [];
    in-out property <string> selected-keyboard-id: "";
    in-out property <bool> start-with-windows: false;
    in-out property <bool> show-in-tray: true;
    in-out property <bool> minimize-to-tray: true;
    in-out property <bool> show-notifications: true;
    in-out property <bool> show-hotkey-dialog: false;
    in-out property <KeyboardInfo> dialog-keyboard;
    
    callback save-settings();
    callback reset-settings();
    callback keyboard-hotkey-changed(string /* keyboard-id */, string /* hotkey */);
    callback open-hotkey-dialog(string /* keyboard-id */);
    
    background: transparent;
    
    ScrollView {
        VerticalLayout {
            padding: Styles.spacing-xl;
            spacing: Styles.spacing-2xl;
            
            // Header
            Text {
                text: "Settings";
                font-size: Fonts.size-2xl;
                font-weight: Fonts.weight-semibold;
                color: Colors.text-primary;
            }
            
            // Settings container with max width for better readability
            Rectangle {
                max-width: 800px;
                
                VerticalLayout {
                    spacing: Styles.spacing-xl;
                    
                    // General Settings
                    Rectangle {
                        background: Colors.surface;
                        border-radius: Styles.radius-lg;
                        drop-shadow-color: Colors.shadow;
                        drop-shadow-offset-y: 2px;
                        drop-shadow-blur: 4px;
                        
                        VerticalLayout {
                            padding: Styles.spacing-xl;
                            spacing: Styles.spacing-lg;
                            
                            Text {
                                text: "General Settings";
                                font-size: Fonts.size-lg;
                                font-weight: Fonts.weight-semibold;
                                color: Colors.text-primary;
                            }
                            
                            VerticalLayout {
                                spacing: Styles.spacing-md;
                                padding-left: Styles.spacing-md;
                                
                                CheckBox {
                                    text: "Start KeyMagic with Windows";
                                    checked <=> root.start-with-windows;
                                }
                                
                                CheckBox {
                                    text: "Show icon in system tray";
                                    checked <=> root.show-in-tray;
                                }
                                
                                CheckBox {
                                    text: "Minimize to system tray";
                                    checked <=> root.minimize-to-tray;
                                    enabled: root.show-in-tray;
                                }
                                
                                CheckBox {
                                    text: "Show notifications when switching keyboards";
                                    checked <=> root.show-notifications;
                                }
                            }
                        }
                    }
                    
                    // Keyboard Hotkeys
                    Rectangle {
                        background: Colors.surface;
                        border-radius: Styles.radius-lg;
                        drop-shadow-color: Colors.shadow;
                        drop-shadow-offset-y: 2px;
                        drop-shadow-blur: 4px;
                        
                        VerticalLayout {
                            padding: Styles.spacing-xl;
                            spacing: Styles.spacing-lg;
                            
                            Text {
                                text: "Keyboard Hotkeys";
                                font-size: Fonts.size-lg;
                                font-weight: Fonts.weight-semibold;
                                color: Colors.text-primary;
                            }
                            
                            if root.keyboards.length == 0: Rectangle {
                                background: Colors.background;
                                border-radius: Styles.radius-md;
                                padding: Styles.spacing-lg;
                                
                                Text {
                                    text: "No keyboards installed. Add keyboards to configure their hotkeys.";
                                    color: Colors.text-disabled;
                                    font-size: Fonts.size-sm;
                                    horizontal-alignment: center;
                                }
                            }
                            
                            // Keyboard list
                            if root.keyboards.length > 0: VerticalLayout {
                                spacing: Styles.spacing-sm;
                                
                                // Header row
                                Rectangle {
                                    height: 40px;
                                    padding-left: Styles.spacing-lg;
                                    padding-right: Styles.spacing-lg;
                                    
                                    HorizontalLayout {
                                        spacing: Styles.spacing-lg;
                                        alignment: stretch;
                                        
                                        Text {
                                            text: "Keyboard";
                                            font-size: Fonts.size-sm;
                                            font-weight: Fonts.weight-semibold;
                                            color: Colors.text-secondary;
                                            horizontal-stretch: 1;
                                            vertical-alignment: center;
                                        }
                                        
                                        Rectangle {
                                            width: 200px;
                                            Text {
                                                text: "Hotkey";
                                                font-size: Fonts.size-sm;
                                                font-weight: Fonts.weight-semibold;
                                                color: Colors.text-secondary;
                                                horizontal-alignment: center;
                                                vertical-alignment: center;
                                            }
                                        }
                                        
                                        Rectangle {
                                            width: 100px;
                                        }
                                    }
                                }
                                
                                // Keyboard rows
                                for keyboard in root.keyboards: Rectangle {
                                    height: 64px;
                                    background: Colors.background;
                                    border-radius: Styles.radius-md;
                                    border-width: 1px;
                                    border-color: Colors.border;
                                    
                                    states [
                                        hover when ta.has-hover: {
                                            background: #FAFAFA;
                                            border-color: Colors.primary-light;
                                        }
                                    ]
                                    
                                    ta := TouchArea {
                                        width: 100%;
                                        height: 100%;
                                    }
                                    
                                    HorizontalLayout {
                                        padding-left: Styles.spacing-lg;
                                        padding-right: Styles.spacing-lg;
                                        spacing: Styles.spacing-lg;
                                        alignment: stretch;
                                        
                                        // Keyboard icon and name
                                        HorizontalLayout {
                                            spacing: Styles.spacing-md;
                                            horizontal-stretch: 1;
                                            alignment: start;
                                            
                                            // Icon
                                            Rectangle {
                                                width: 32px;
                                                height: 32px;
                                                
                                                if keyboard.has-icon: Rectangle {
                                                    width: 32px;
                                                    height: 32px;
                                                    border-radius: Styles.radius-sm;
                                                    background: Colors.surface;
                                                    border-width: 1px;
                                                    border-color: Colors.border;
                                                    
                                                    Image {
                                                        source: keyboard.icon;
                                                        width: 24px;
                                                        height: 24px;
                                                        x: (parent.width - self.width) / 2;
                                                        y: (parent.height - self.height) / 2;
                                                        image-fit: contain;
                                                    }
                                                }
                                            }
                                            
                                            // Name and description
                                            VerticalLayout {
                                                spacing: 2px;
                                                horizontal-stretch: 1;
                                                alignment: center;
                                                
                                                Text {
                                                    text: keyboard.name;
                                                    font-size: Fonts.size-base;
                                                    font-weight: Fonts.weight-medium;
                                                    color: Colors.text-primary;
                                                    overflow: elide;
                                                }
                                                
                                                if keyboard.description != "": Text {
                                                    text: keyboard.description;
                                                    font-size: Fonts.size-xs;
                                                    color: Colors.text-secondary;
                                                    overflow: elide;
                                                }
                                            }
                                        }
                                        
                                        // Current hotkey
                                        Rectangle {
                                            width: 200px;
                                            
                                            Rectangle {
                                                height: 36px;
                                                background: keyboard.hotkey != "" ? Colors.primary-light : Colors.background;
                                                border-radius: Styles.radius-md;
                                                border-width: 1px;
                                                border-color: keyboard.hotkey != "" ? Colors.primary : Colors.border;
                                                y: (parent.height - self.height) / 2;
                                                
                                                HorizontalLayout {
                                                    padding-left: Styles.spacing-md;
                                                    padding-right: Styles.spacing-md;
                                                    alignment: center;
                                                    
                                                    Text {
                                                        text: keyboard.hotkey != "" ? keyboard.hotkey : "Not set";
                                                        font-size: Fonts.size-sm;
                                                        font-weight: keyboard.hotkey != "" ? Fonts.weight-medium : Fonts.weight-normal;
                                                        color: keyboard.hotkey != "" ? Colors.text-on-primary : Colors.text-disabled;
                                                        horizontal-alignment: center;
                                                        vertical-alignment: center;
                                                        horizontal-stretch: 1;
                                                    }
                                                    
                                                    if keyboard.custom-hotkey != "" && keyboard.default-hotkey != "": Text {
                                                        text: "•";
                                                        font-size: Fonts.size-xs;
                                                        color: Colors.info;
                                                        vertical-alignment: center;
                                                    }
                                                }
                                            }
                                        }
                                        
                                        // Configure button
                                        Rectangle {
                                            width: 100px;
                                            
                                            Button {
                                                text: "Configure";
                                                width: 100px;
                                                y: (parent.height - self.height) / 2;
                                                clicked => {
                                                    root.open-hotkey-dialog(keyboard.id);
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            
                            // Help text
                            Rectangle {
                                padding-top: Styles.spacing-md;
                                
                                HorizontalLayout {
                                    spacing: Styles.spacing-sm;
                                    alignment: start;
                                    
                                    Text {
                                        text: "ℹ";
                                        font-size: Fonts.size-sm;
                                        color: Colors.info;
                                        vertical-alignment: top;
                                    }
                                    
                                    Text {
                                        text: "Configure hotkeys to quickly switch between keyboards. The blue dot (•) indicates a custom hotkey is set.";
                                        font-size: Fonts.size-xs;
                                        color: Colors.text-disabled;
                                        wrap: word-wrap;
                                        horizontal-stretch: 1;
                                    }
                                }
                            }
                        }
                    }
                    
                    // Action buttons
                    HorizontalLayout {
                        spacing: Styles.spacing-md;
                        alignment: end;
                        padding-top: Styles.spacing-md;
                        
                        Button {
                            text: "Reset to Defaults";
                            clicked => { root.reset-settings(); }
                        }
                        
                        Button {
                            text: "Save Settings";
                            primary: true;
                            clicked => { root.save-settings(); }
                        }
                    }
                }
            }
            
            // Spacer at bottom
            Rectangle {
                height: Styles.spacing-xl;
            }
        }
    }
    
    // Hotkey configuration dialog
    HotkeyDialog {
        show: root.show-hotkey-dialog;
        keyboard: root.dialog-keyboard;
        width: parent.width;
        height: parent.height;
        
        confirm-hotkey(keyboard-id, hotkey) => {
            root.keyboard-hotkey-changed(keyboard-id, hotkey);
            root.show-hotkey-dialog = false;
        }
        
        cancel => {
            root.show-hotkey-dialog = false;
        }
        
        use-default => {
            root.keyboard-hotkey-changed(root.dialog-keyboard.id, "");
            root.show-hotkey-dialog = false;
        }
    }
}